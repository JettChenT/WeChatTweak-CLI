name: Build and Publish

on:
 push:
   branches: [ main ]

jobs:
 build:
   runs-on: ${{ matrix.os }}
   strategy:
     matrix:
       os: [macos-latest, macos-11.0-arm64]
   steps:
     - name: Checkout code
       uses: actions/checkout@v2

     - name: Purge cache and clean
       run: |
         swift package purge-cache
         swift package clean

     - name: Build
       run: |
         swift build -c release

     - name: Copy binary
       run: |
         cp ./.build/release/wechattweak-cli ./release/wechattweak-cli

     - name: Archive production artifacts
       uses: actions/upload-artifact@v2
       with:
         name: wechattweak-cli
         path: ./release/wechattweak-cli

     - name: Create Release
       id: create_release
       uses: actions/create-release@v1
       env:
         GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
       with:
         tag_name: ${{ github.ref }}
         release_name: Release ${{ github.ref }}
         draft: false
         prerelease: false

     - name: Upload Release Asset
       id: upload_release_asset
       uses: actions/upload-release-asset@v1
       env:
         GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
       with:
         upload_url: ${{ steps.create_release.outputs.upload_url }}
         asset_path: ./release/wechattweak-cli
         asset_name: wechattweak-cli
         asset_content_type: application/octet-stream
